"use strict";!function($){var previewMimeTypes={image:["image/png","image/jpeg","image/gif"]},supported={filereader:"undefined"!=typeof FileReader,dnd:"draggable"in document.createElement("span"),formdata:!!window.FormData,progress:"upload"in new XMLHttpRequest},defaults={name:"file",accept:["image/png","image/jpeg","image/gif"],language:{invalidMimeType:"Invalid mime type."},url:null,fields:{},holder:null,progress:null,preview:null,complete:null,error:null,debug:!1,history:[],currentProgress:0};$.fn.html5uploader=function(options){var settings=$.extend({},defaults,options||{}),consoleLog=function(){settings.debug===!0&&(settings.history.push(arguments),this.console&&console.log(Array.prototype.slice.call(arguments)))},fileSelect=function(e,s){if(consoleLog("fileselect",s),!settings.url)return void consoleLog("no url set");var t=supported.formdata===!0?new FormData:null;if(supported.formdata===!0){consoleLog("formdata supported"),settings.progress&&0!=settings.currentProgress&&(consoleLog("progress",0),settings.currentProgress=0,settings.progress(0)),t.append(settings.name,s),settings.fields&&$.each(settings.fields,function(e,s){t.append(e,s)});var n=new XMLHttpRequest;n.onload=function(e){if(setProgress(100),e.target.responseText){var t=JSON.parse(e.target.responseText);t&&setComplete(s,t)}},settings.progress&&supported.progress===!0&&(consoleLog("progress supported"),n.upload.onprogress=function(e){if(e.lengthComputable){var s=e.loaded/e.total*100|0;setProgress(s)}}),n.open("POST",settings.url),n.send(t)}else setComplete(settings,s,{});if(settings.preview&&supported.filereader===!0&&-1!=$.inArray(s.type,previewMimeTypes.image)){consoleLog("filereader supported");var o=new FileReader;o.onload=function(e){if("string"==typeof settings.preview){var s=window[settings.preview];"function"==typeof s&&s(e.target.result)}else settings.preview(e.target.result)},o.readAsDataURL(s)}},setError=function(e,s){if(settings.error)if("string"==typeof settings.error){var s=window[settings.error];"function"==typeof s&&s.call(this,e,s,"")}else settings.error.call(this,e,s,"")},setComplete=function(e,s){if(settings.complete)if("string"==typeof settings.complete){var t=window[settings.complete];"function"==typeof t&&t.call(this,e,s)}else"function"==typeof settings.complete&&settings.complete.call(this,e,s);s.error&&setError(e,s.error)},setProgress=function(e){if(settings.progress&&settings.currentProgress!=e)if(consoleLog("progress",e),settings.currentProgress=e,"string"==typeof settings.progress){var s=window[settings.progress];"function"==typeof s&&s(e)}else"function"==typeof settings.progress&&settings.progress(e)};return this.each(function(){var self=$(this);if(self.is("input[type=file]")){if("undefined"!=typeof self.attr("name")&&(settings.name=self.attr("name"),consoleLog("set name",settings.name)),"undefined"!=typeof self.data("name")&&(settings.name=self.data("name"),consoleLog("set name",settings.name)),"undefined"!=typeof self.data("url")&&(settings.url=self.data("url"),consoleLog("set url",settings.url)),"undefined"!=typeof self.attr("accept")){var accept=self.attr("accept");settings.accept=accept.split("|"),consoleLog("set accept",settings.accept)}else"undefined"!=typeof settings.accept&&(self.attr("accept",settings.accept.join("|")),consoleLog("set accept",settings.accept));if("undefined"!=typeof self.data("fields")){var fields=self.data("fields");if("string"==typeof fields){var _fields=window[fields];if("function"==typeof _fields)settings.fields=_fields;else{var dataFields=fields.split("|");dataFields.length&&(settings.fields={},$.each(dataFields,function(key,dataField){var value=dataField.split("=");value.length&&eval("settings.fields."+value[0]+' = "'+value[1]+'";')}))}}consoleLog("set fields",settings.fields)}"undefined"!=typeof self.data("holder")&&(settings.holder=self.data("holder"),consoleLog("set holder",settings.holder)),"undefined"!=typeof self.data("progress")&&(settings.progress=self.data("progress"),consoleLog("set progress",settings.progress)),"undefined"!=typeof self.data("complete")&&(settings.complete=self.data("complete"),consoleLog("set complete",settings.complete)),"undefined"!=typeof self.data("preview")&&(settings.preview=self.data("preview"),consoleLog("set preview",settings.preview)),supported.dnd&&settings.holder&&(consoleLog("dnd supported"),$(settings.holder).on("dragover",function(){return $(this).addClass("hover"),self.addClass("disabled"),setProgress(0),!1}).on("dragend",function(){return $(this).removeClass("hover"),self.removeClass("disabled"),setProgress(0),!1}).on("drop",function(e){e.preventDefault(),e.dataTransfer=e.originalEvent.dataTransfer,$(this).removeClass("hover"),self.removeClass("disable");var s="undefined"!=e.dataTransfer&&e.dataTransfer.files.length?e.dataTransfer.files[0]:null;if(s){var t=$.inArray(s.type,settings.accept);consoleLog("file chosen",s,t),-1!=t&&(consoleLog("acceptable mime type",s.type,settings.accept),fileSelect(e,s))}})),self.change(function(){var e=$(this).get(0).files[0];if(setProgress(0),e){var s=$.inArray(e.type,settings.accept);consoleLog("file chosen",e,s),-1!=s?(consoleLog("acceptable mime type",e.type,settings.accept),$(this).trigger("fileselect",e)):setError(e,settings.language.invalidMimeType)}}).on("fileselect",fileSelect)}})}}(jQuery);
"use strict";!function($){var previewMimeTypes={image:["image/png","image/jpeg","image/gif"]},supported={filereader:"undefined"!=typeof FileReader,dnd:"draggable"in document.createElement("span"),formdata:!!window.FormData,progress:"upload"in new XMLHttpRequest},defaults={name:"file",accept:["image/png","image/jpeg","image/gif"],language:{invalidMimeType:"Invalid mime type."},url:null,fields:{},holder:null,progress:null,preview:null,complete:null,error:null,debug:!1,history:[],currentProgress:0};$.fn.html5uploader=function(options){var settings=$.extend({},defaults,options||{}),consoleLog=function(){settings.debug===!0&&(settings.history.push(arguments),this.console&&console.log(Array.prototype.slice.call(arguments)))},fileSelect=function(a,b){if(consoleLog("fileselect",b),!settings.url)return void consoleLog("no url set");var c=supported.formdata===!0?new FormData:null;if(supported.formdata===!0){consoleLog("formdata supported"),settings.progress&&0!=settings.currentProgress&&(consoleLog("progress",0),settings.currentProgress=0,settings.progress(0)),c.append(settings.name,b),settings.fields&&$.each(settings.fields,function(a,b){c.append(a,b)});var d=new XMLHttpRequest;d.onload=function(a){if(setProgress(100),a.target.responseText){var c=JSON.parse(a.target.responseText);c&&setComplete(b,c)}},settings.progress&&supported.progress===!0&&(consoleLog("progress supported"),d.upload.onprogress=function(a){if(a.lengthComputable){var b=a.loaded/a.total*100|0;setProgress(b)}}),d.open("POST",settings.url),d.send(c)}else setComplete(settings,b,{});if(settings.preview&&supported.filereader===!0&&$.inArray(b.type,previewMimeTypes.image)!=-1){consoleLog("filereader supported");var e=new FileReader;e.onload=function(a){if("string"==typeof settings.preview){var b=window[settings.preview];"function"==typeof b&&b(a.target.result)}else settings.preview(a.target.result)},e.readAsDataURL(b)}},setError=function(a,b){if(settings.error)if("string"==typeof settings.error){var b=window[settings.error];"function"==typeof b&&b.call(this,a,b,"")}else settings.error.call(this,a,b,"")},setComplete=function(a,b){if(settings.complete)if("string"==typeof settings.complete){var c=window[settings.complete];"function"==typeof c&&c.call(this,a,b)}else"function"==typeof settings.complete&&settings.complete.call(this,a,b);b.error&&setError(a,b.error)},setProgress=function(a){if(settings.progress&&settings.currentProgress!=a)if(consoleLog("progress",a),settings.currentProgress=a,"string"==typeof settings.progress){var b=window[settings.progress];"function"==typeof b&&b(a)}else"function"==typeof settings.progress&&settings.progress(a)};return this.each(function(){var self=$(this);if(self.is("input[type=file]")){if("undefined"!=typeof self.attr("name")&&(settings.name=self.attr("name"),consoleLog("set name",settings.name)),"undefined"!=typeof self.data("name")&&(settings.name=self.data("name"),consoleLog("set name",settings.name)),"undefined"!=typeof self.data("url")&&(settings.url=self.data("url"),consoleLog("set url",settings.url)),"undefined"!=typeof self.attr("accept")){var accept=self.attr("accept");settings.accept=accept.split("|"),consoleLog("set accept",settings.accept)}else"undefined"!=typeof settings.accept&&(self.attr("accept",settings.accept.join("|")),consoleLog("set accept",settings.accept));if("undefined"!=typeof self.data("fields")){var fields=self.data("fields");if("string"==typeof fields){var _fields=window[fields];if("function"==typeof _fields)settings.fields=_fields;else{var dataFields=fields.split("|");dataFields.length&&(settings.fields={},$.each(dataFields,function(key,dataField){var value=dataField.split("=");value.length&&eval("settings.fields."+value[0]+' = "'+value[1]+'";')}))}}consoleLog("set fields",settings.fields)}"undefined"!=typeof self.data("holder")&&(settings.holder=self.data("holder"),consoleLog("set holder",settings.holder)),"undefined"!=typeof self.data("progress")&&(settings.progress=self.data("progress"),consoleLog("set progress",settings.progress)),"undefined"!=typeof self.data("complete")&&(settings.complete=self.data("complete"),consoleLog("set complete",settings.complete)),"undefined"!=typeof self.data("preview")&&(settings.preview=self.data("preview"),consoleLog("set preview",settings.preview)),supported.dnd&&settings.holder&&(consoleLog("dnd supported"),$(settings.holder).on("dragover",function(a){return $(this).addClass("hover"),self.addClass("disabled"),setProgress(0),!1}).on("dragend",function(a){return $(this).removeClass("hover"),self.removeClass("disabled"),setProgress(0),!1}).on("drop",function(a){a.preventDefault(),a.dataTransfer=a.originalEvent.dataTransfer,$(this).removeClass("hover"),self.removeClass("disable");var b="undefined"!=a.dataTransfer&&a.dataTransfer.files.length?a.dataTransfer.files[0]:self.files[0];if(b){var c=$.inArray(b.type,settings.accept);consoleLog("file chosen",b,c),c!=-1&&(consoleLog("acceptable mime type",b.type,settings.accept),fileSelect(a,b))}})),self.change(function(a){var b=$(this).get(0).files[0];if(setProgress(0),b){var c=$.inArray(b.type,settings.accept);consoleLog("file chosen",b,c),c!=-1?(consoleLog("acceptable mime type",b.type,settings.accept),$(this).trigger("fileselect",b)):setError(b,settings.language.invalidMimeType)}}).on("fileselect",fileSelect)}})}}(jQuery);
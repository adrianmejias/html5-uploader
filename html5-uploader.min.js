!function($){$.fn.html5uploader=function(options){var defaults={accept:["image/png","image/jpeg","image/gif"],url:null,fields:null,holder:null,progress:null,preview:null,complete:null,debug:!1,history:[],currentProgress:0},settings=$.extend(defaults,options),previewMimeTypes={image:["image/png","image/jpeg","image/gif"]},supported={filereader:"undefined"!=typeof FileReader,dnd:"draggable"in document.createElement("span"),formdata:!!window.FormData,progress:"upload"in new XMLHttpRequest},consoleLog=function(){settings.debug===!0&&(settings.history.push(arguments),this.console&&console.log(Array.prototype.slice.call(arguments)))},fileSelect=function(a,b){if(consoleLog("fileselect",b),!settings.url)return consoleLog("no url set"),void 0;var c=supported.formdata===!0?new FormData:null;if(supported.formdata===!0){consoleLog("formdata supported"),settings.progress&&0!=settings.currentProgress&&(consoleLog("progress",0),settings.currentProgress=0,settings.progress(0)),c.append("file",b),settings.fields&&$.each(settings.fields,function(a,b){c.append(a,b)});var d=new XMLHttpRequest;d.onload=function(a){if(setProgress(100),a.target.responseText){var c=JSON.parse(a.target.responseText);if(settings.complete)if("string"==typeof settings.complete){var d=window[settings.complete];"function"==typeof d&&d(b,c)}else settings.complete(b,c)}},settings.progress&&supported.progress===!0&&(consoleLog("progress supported"),d.upload.onprogress=function(a){if(a.lengthComputable){var b=0|100*(a.loaded/a.total);setProgress(b)}}),d.open("POST",settings.url),d.send(c)}else if(settings.complete)if("string"==typeof settings.complete){var e=window[settings.complete];"function"==typeof e&&e(b,response)}else settings.complete(b,response);if(settings.preview&&supported.filereader===!0&&-1!=$.inArray(b.type,previewMimeTypes.image)){consoleLog("filereader supported");var f=new FileReader;f.onload=function(a){if("string"==typeof settings.preview){var b=window[settings.preview];"function"==typeof b&&b(a.target.result)}else settings.preview(a.target.result)},f.readAsDataURL(b)}},setProgress=function(a){if(settings.progress&&settings.currentProgress!=a)if(consoleLog("progress",a),settings.currentProgress=a,"string"==typeof settings.progress){var b=window[settings.progress];"function"==typeof b&&b(a)}else settings.progress(a)};return this.each(function(){var $input=$(this);if($input.is("input")){if("undefined"!==$input.data("url")&&(settings.url=$input.data("url")),$input.attr("accept")?settings.accept=$input.attr("accept").split("|"):settings.accept&&$input.attr("accept",settings.accept.join("|")),"undefined"!==$input.data("fields")){var fields=$input.data("fields");if("string"==typeof fields){var _fields=window[fields];if("function"==typeof _fields)settings.fields=_fields;else{var dataFields=fields.split("|");dataFields.length&&(settings.fields={},$.each(dataFields,function(key,dataField){var value=dataField.split("=");value.length&&eval("settings.fields."+value[0]+' = "'+value[1]+'";')}))}}}"undefined"!==$input.data("holder")&&(settings.holder=$input.data("holder")),"undefined"!==$input.data("progress")&&(settings.progress=$input.data("progress")),"undefined"!==$input.data("complete")&&(settings.complete=$input.data("complete")),"undefined"!==$input.data("preview")&&(settings.preview=$input.data("preview")),supported.dnd&&settings.holder&&(consoleLog("dnd supported"),$(settings.holder).on("dragover",function(){return $(this).addClass("hover"),$input.addClass("disabled"),setProgress(0),!1}).on("dragend",function(){return $(this).removeClass("hover"),$input.removeClass("disabled"),setProgress(0),!1}).on("drop",function(a){a.preventDefault(),a.dataTransfer=a.originalEvent.dataTransfer,$(this).removeClass("hover"),$input.removeClass("disable");var b="undefined"!=a.dataTransfer&&a.dataTransfer.files.length?a.dataTransfer.files[0]:null;if(b){var c=$.inArray(b.type,settings.accept);consoleLog("file chosen",b,c),-1!=c&&(consoleLog("acceptable mime type",b.type,settings.accept),fileSelect(a,b))}})),$input.change(function(){var b=$(this).get(0).files[0];if(setProgress(0),b){var c=$.inArray(b.type,settings.accept);consoleLog("file chosen",b,c),-1!=c&&(consoleLog("acceptable mime type",b.type,settings.accept),$(this).trigger("fileselect",b))}}).on("fileselect",fileSelect)}})}}(jQuery);